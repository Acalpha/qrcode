function BookmarkStore(){["onChanged","onCreated"].forEach(function(a){chrome.bookmarks[a].addListener(this._handleExternalChanges.bind(this,a))},this)}
BookmarkStore.prototype={_isLocked:!1,getIdentity:function(a){return a.id},get:function(a){var b=when.defer();chrome.bookmarks.search(a,function(c){if(!c||0===c.length)b.resolve(null);else{var d={id:a,bids:[],tids:[]};c.forEach(function(a){d.id===a.url&&(d.bids.push(a.id),d.tids.push(a.parentId),d.title=a.title)});0<d.bids.length?b.resolve(d):b.resolve(null)}});return b},add:function(a){this._isLocked=!0;var b=this;return when.all(a.tids.map(function(c){var b=when.defer();chrome.bookmarks.create({title:a.title,
url:a.id,parentId:c},function(){b.resolve()});return b})).then(function(){b._isLocked=!1;return a.id})},remove:function(a){return when.all(a.bids.map(function(a){var c=when.defer();chrome.bookmarks.remove(a,function(){c.resolve()});return c})).then(function(){return!0})},getDifference:function(a,b){return a.filter(function(a){return b.every(function(b){return b!==a})})},getIntersection:function(a,b){return a.filter(function(a){return b.some(function(b){return b===a})})},put:function(a,b){var c=this;
this._isLocked=!0;var d=b.oldItem,n=d.title!==a.title,g={},h=[],i=[];d.tids.forEach(function(a,b){g[a]=d.bids[b];h.push(a)});a.tids.forEach(function(a){i.push(a)});var e=this.getDifference(h,i),o=this.getIntersection(h,i),f=this.getDifference(i,h);[e,o,f].forEach(function(){});var m=function(a,b){var c=when.defer();chrome.bookmarks.update(a,{title:b},function(){c.resolve()});return c};if(0===e.length&&0===f.length)return when.all(d.bids.map(function(b){return m(b,a.title)})).then(function(){c._isLocked=
!1;return a.id});var j=e,k=f,l=!0;e.length<f.length&&(j=f,k=e,l=!1);var p=j.map(function(b,c){var d=when.defer(),e=[d];if(c<k.length){var f=g[l?j[c]:k[c]];chrome.bookmarks.move(f,{parentId:l?k[c]:j[c]},function(){d.resolve()});n&&e.push(m(f,a.title))}else l?chrome.bookmarks.remove(g[b],function(){d.resolve()}):chrome.bookmarks.create({title:a.title,url:a.id,parentId:b},function(){d.resolve()});return when.all(e)});n&&o.forEach(function(b){p.push(m(g[b],a.title))});c=this;return when.all(p).then(function(){c._isLocked=
false;return a.id})},query:function(a,b){return this[b.recursive?"_getDescendants":"_getChildren"](a.tag)},_getChildren:function(a){var b=when.defer();chrome.bookmarks.getChildren(a.id,function(a){b.resolve(a.filter(function(a){return"url"in a}).map(function(a){return a}))});return b},_getDescendants:function(a){var b=when.defer(),c=this,d=[];chrome.bookmarks.getSubTree(a.id,function(a){c._collectChildren(a[0].children,d);b.resolve(d)});return b},_collectChildren:function(a,b){a.forEach(function(a){a.url?
b.push(a):this._collectChildren(a.children,b)},this)},_handleExternalChanges:function(a,b,c){this._isLocked||c.url&&this._syncTitle(a,b,c)},_syncTitle:function(a,b,c){this.get(c.url).then(function(a){a.bids.forEach(function(a){a!==b&&chrome.bookmarks.get(a,function(a){a=a[0];a.title!==c.title&&chrome.bookmarks.update(a.id,{title:c.title})})})})}};
