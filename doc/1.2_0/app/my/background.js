function escapeRegExp(a,b){return a.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,function(a){return b&&-1!==b.indexOf(a)?a:"\\"+a})}
var bg={init:function(){var a=this;this.setOptions();this.tagStore=new TagStore({bg:this});this.bookmarkStore=new BookmarkStore;this.tagStore.createIndex().then(function(){a.options.defaultParentId||a.updateOptions({defaultParentId:a.tagStore.topLevelContainerId})});this.setIconUpdater();this.setOmniboxEventHandlers();chrome.tabs.query({active:!0},function(b){a.updateIcon(b[0].id)})},convertStoredValue:function(a,b){var c;switch(b){case "number":c=parseInt(a);break;case "boolean":c="true"===a;break;
default:c=a}return c},setOptions:function(){var a=this.options={},b={ignoreDiacritics:[!0,"boolean"],unignoredDiacritics:["","string"],ignoreSpaces:[!0,"boolean"],ignoreCase:[!0,"boolean"],ignoredPunctuations:["","string"],aliasPrefix:["","string"],modeSwitch:[">","string"],andSeparator:["&","string"],nextPage:[">","string"],recursiveSearch:[!1,"boolean"],searchDelay:[100,"number"],alertBar:[!1,"boolean"],expandTopLevel:[!0,"boolean"],defaultParentId:["","string"]},c;for(c in b){var d=b[c][0],e=b[c][1];
c in localStorage?a[c]=this.convertStoredValue(localStorage[c],e):(a[c]=d,localStorage[c]=d)}},updateOptions:function(a){var b=!1,c={ignoreDiacritics:!0,unignoredDiacritics:!0,aliasPrefix:!0,ignoreSpaces:!0,ignoreCase:!0,ignoredPunctuations:!0},d;for(d in a)localStorage[d]=a[d],this.options[d]=a[d],c[d]&&(b=!0);b&&this.tagStore.createIndex()},updateIcon:function(a){chrome.pageAction.show(a)},setIconUpdater:function(){var a=this;chrome.tabs.onUpdated.addListener(function(b,c,d){"complete"!==d.status&&
a.updateIcon(b)})},addBookmark:function(a){return this.bookmarkStore.add(a)},updateBookmark:function(a,b){return this.bookmarkStore.put(b,{oldItem:a})},removeBookmark:function(a){return this.bookmarkStore.remove(a)},addTag:function(a){return this.tagStore.add(a)},renameTag:function(a){return this.tagStore.put(a,{changed:"title"})},setOmniboxEventHandlers:function(){var a=this,b=this.options;chrome.omnibox.onInputCancelled.addListener(function(){a.timer&&a.clearTimer();a.omniboxCache&&(a.omniboxCache=
null);a.setDefaultSuggestion()});chrome.omnibox.onInputEntered.addListener(function(b){a.omniboxCache=null;chrome.tabs.update(null,{url:b})});chrome.omnibox.onInputStarted.addListener(function(){a.updateOmniboxRe();a.updateDefaultSuggestion();a.setDefaultSuggestion()});chrome.omnibox.onInputChanged.addListener(function(c,d){a.timer&&a.clearTimer();a.omniboxRe.empty.test(c)?a.setDefaultSuggestion():a.timer=setTimeout(function(){a.search(c,d)},b.searchDelay)})},timer:null,omniboxCache:null,encodeHtml:function(a){var b=
{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};return a.replace(/[&<>"]/g,function(a){return b[a]})},clearTimer:function(){clearTimeout(this.timer);this.timer=null},updateDefaultSuggestion:function(){var a=this.options,b=chrome.i18n.getMessage,c=[];["andSeparator","modeSwitch","nextPage"].forEach(function(d){c.push(a[d]?'"'+a[d]+'"':b("disabled"))});this.defaultSuggestion=this.encodeHtml(b("omnibox_description",c))},setDefaultSuggestion:function(a){chrome.omnibox.setDefaultSuggestion({description:this.defaultSuggestion+
(a?"  "+a:"")})},updateOmniboxRe:function(){var a=this.options,b=this.omniboxRe={};b.empty=RegExp("^[\\s"+a.modeSwitch+a.andSeparator+a.nextPage+"]*$");a.modeSwitch&&(b.modeSwitch=RegExp("^("+escapeRegExp(a.modeSwitch)+"?)(.+)$"));a.nextPage&&(b.pager=RegExp("^(.+?)("+escapeRegExp(a.nextPage)+"*)$"))},wait:function(a,b){"object"===typeof a&&a.then?a.then(b):b(a)},search:function(a,b){this.clearTimer();var c=this,d=this.parseText(a);this.wait(this.isCacheAvailable(d),function(a){a?c.sendSuggestion(b):
c.createCache(d).then(function(){c.sendSuggestion(b)})})},createCache:function(a){this.omniboxCache={lastQuery:a,tokens:[]};return this.addTokenGroups(a.tokens)},addTokenGroups:function(a){var b=this.omniboxCache,c={recursive:b.lastQuery.recursive},d=this;return when.all(a.map(function(a){var f={token:RegExp("^"+escapeRegExp(a)),tags:[]};b.tokens.push(f);return d.tagStore.query({title:a}).then(function(a){return 0===a.length?!0:when.all(a.map(function(a){var b={key:a.key,bookmarks:[]};f.tags.push(b);
return d.bookmarkStore.query({tag:a},c).then(function(a){a.forEach(function(a){b.bookmarks.push({title:a.title,url:a.url,tid:a.parentId})})})}))})})).then(function(){return!0})},getUnion:function(a){var b={};a.forEach(function(a){a.bookmarks.forEach(function(a){var c=a.url,d=a.tid;b[c]?0>b[c].tids.indexOf(d)&&b[c].tids.push(d):b[c]={title:a.title,url:c,tids:[d]}})});var a=[],c;for(c in b)a.push(b[c]);return a},getIntersection:function(a){return a.reduce(function(a,c){var d=[];a.forEach(function(a){c.forEach(function(b){if(a.url===
b.url){var c={title:a.title,url:a.url,tids:a.tids.slice()};b.tids.forEach(function(b){0>a.tids.indexOf(b)&&c.tids.push(b)});d.push(c)}})});return d})},prepareResults:function(){var a=this.omniboxCache,b=a.lastQuery,c=[];b.tokens.forEach(function(b){for(var e=0;e<a.tokens.length;e++)if(a.tokens[e].token.test(b)){c.push(a.tokens[e]);break}});a.preparedResults=this.getIntersection(c.map(function(a,c){var f=RegExp("^"+escapeRegExp(b.tokens[c]));return this.getUnion(a.tags.filter(function(a){return f.test(a.key)},
this))},this))},parseText:function(a){var b=this.options,c=this.omniboxRe,d=b.recursiveSearch;b.modeSwitch&&(a=c.modeSwitch.exec(a),a[1]&&(d=!d),a=a[2]);var e=0;b.nextPage&&(a=c.pager.exec(a),a[2]&&(e=5*a[2].length),a=a[1]);b.andSeparator?(b=a.split(b.andSeparator),c=b.length,1<c&&""===b[c-1]&&b.pop()):b=[a];b=b.map(function(a){return this.tagStore.normalize(a)},this);return{tokens:b,offset:e,recursive:d}},isCacheAvailable:function(a){var b=!0;if(this.omniboxCache){var c=this.omniboxCache,d=c.lastQuery;
if(a.recursive!==d.recursive)b=!1;else if(a.tokens.length===d.tokens.length&&a.tokens.every(function(a,b){return a===d.tokens[b]}))c.lastQuery=a;else{c.preparedResults=null;c.lastQuery=a;var e=[];a.tokens.forEach(function(a){c.tokens.every(function(b){return!b.token.test(a)})&&e.push(a)});0<e.length&&(b=this.addTokenGroups(e))}}else b=!1;return b},sendSuggestion:function(a){var b=this.omniboxCache;b.preparedResults||this.prepareResults();var c=b.lastQuery.offset,d=b.preparedResults.slice(c,c+5),b=
c>=b.preparedResults.length?"":chrome.i18n.getMessage("omnibox_pager",[(c+5)/5,Math.ceil(b.preparedResults.length/5)]);this.setDefaultSuggestion(b);a(d.map(function(a){return{content:a.url,description:"<match>"+this.encodeHtml(a.title)+"</match>   ["+this.encodeHtml(a.tids.map(function(a){return this.tagStore.getName(a,!0)},this).join("], ["))+"] - <url>"+this.encodeHtml(a.url)+"</url>"}},this))}};bg.init();
