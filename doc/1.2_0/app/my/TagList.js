function TagList(a,b){for(var c in a)this[c]=a[c];this.items={};this.cache=[];(this.domNode=document.getElementById(b)).className="tagList";this.createItemContainer();this.createAddButton();this.createEditor();this.createMenu();this.addEventListeners()}
TagList.prototype={store:null,defaultParentId:null,items:null,cache:null,isMenuOpen:!1,selectedIndex:-1,keys:{ENTER:13,UP:38,DOWN:40},itemContainer:null,addButton:null,editor:null,menu:null,on:function(a,b,c){if(c)$(this.domNode).on(a,b,c);else $(this.domNode).on(a,b)},emit:function(a,b){$(this.domNode).trigger(a,b)},createItemContainer:function(){var a=this.itemContainer=document.createElement("span");this.domNode.appendChild(a)},createAddButton:function(){var a=this.addButton=document.createElement("span");
a.className="tagListAddButton";a.title=chrome.i18n.getMessage("popup_tagListAddButtonLabel");var b=document.createElement("span");b.className="tagListAddButtonContent";a.appendChild(b);var c=document.createElement("span");c.className="tagListAddButtonLabel";c.textContent="+";b.appendChild(c);this.domNode.appendChild(a);$(a).on("click",this.openEditor.bind(this))},createEditor:function(){var a=this.editor=document.createElement("input");a.className="tagListEditor tagListMenuItemSelected";$(a).on("input",
this.search.bind(this)).on("keydown",this.handleEditorKeydown.bind(this))},createMenu:function(){var a=this.menu=document.createElement("div");a.className="tagListMenu";document.body.appendChild(a);var b=this;$(a).on("mouseover",".tagListMenuItem",function(){-1<b.selectedIndex?a.children[b.selectedIndex].classList.remove("tagListMenuItemSelected"):b.editor.classList.remove("tagListMenuItemSelected");this.classList.add("tagListMenuItemSelected");for(var c,d=0;d<a.children.length;d++)if(a.children[d]===
this){c=d;break}b.selectedIndex=c}).on("mouseout",function(c){c.target===a&&-1<b.selectedIndex&&(a.children[b.selectedIndex].classList.remove("tagListMenuItemSelected"),b.editor.classList.add("tagListMenuItemSelected"),b.selectedIndex=-1)}).on("click",".tagListMenuItem",this.selectItem.bind(this))},createItem:function(a){var b=document.createElement("span");b.className="tagListItem";b.dataset.tid=a;var c=document.createElement("span");c.className="tagListItemContent";b.appendChild(c);var d=document.createElement("span");
d.className="tagListItemLabel";d.textContent=this.store.getName(a,!0);c.appendChild(d);a=document.createElement("span");a.className="tagListItemRemoveButton";a.title=chrome.i18n.getMessage("popup_tagListItemRemoveButtonLabel");c.appendChild(a);return b},addItem:function(a){var b=this.createItem(a);this.items[a]=b;this.itemContainer.appendChild(b)},removeItem:function(a){this.itemContainer.removeChild(this.items[a]);delete this.items[a]},renameItem:function(a){this.items[a]&&(this.items[a].firstElementChild.firstElementChild.textContent=
this.store.getName(a,!0))},selectItem:function(){if(-1<this.selectedIndex){var a=this.menu.children[this.selectedIndex].dataset.tid;this.closeEditor();this.addItem(a);this.emit("taglist-add",{id:a})}else a=this.editor.value.trim(),this.closeEditor(),a&&this.createTag(a)},createTag:function(a){var b=this.defaultParentId,c=this;this.store.add({title:a,parentId:b}).then(function(d){c.addItem(d);c.emit("taglist-create",{id:d,title:a,parentId:b})})},openEditor:function(){this.domNode.removeChild(this.addButton);
this.domNode.appendChild(this.editor);this.editor.focus()},closeEditor:function(){this.closeMenu();this.editor.parentNode&&(this.editor.value="",this.domNode.removeChild(this.editor),this.domNode.appendChild(this.addButton))},wait:function(a,b){"object"===typeof a&&a.then?a.then(b):b(a)},search:function(){var a=this.editor.value.trim();-1!==this.selectedIndex&&(this.menu.children[this.selectedIndex].classList.remove("tagListMenuItemSelected"),this.editor.classList.add("tagListMenuItemSelected"),this.selectedIndex=
-1);if(a){var b=this;this.wait(this.prepareResults(a),function(a){a.length>0?b.showResults(a):b.closeMenu()})}else this.closeMenu()},prepareResults:function(a){for(var b=chrome.extension.getBackgroundPage().escapeRegExp,a=this.store.normalize(a),c=this.cache,d=this.getSelected(),e=0;e<c.length;e++){var f=c[e];if(f.token.test(a)){var g=RegExp("^"+b(a));return f.tags.filter(function(a){return g.test(a.key)&&0>d.indexOf(a.id)}).map(function(a){return{id:a.id}})}}f={token:RegExp("^"+b(a)),tags:[]};c.push(f);
return this.store.query({title:a}).then(function(a){var b=[];a.forEach(function(a){f.tags.push({id:a.id,key:a.key});0>d.indexOf(a.id)&&b.push({id:a.id})});return b})},getSelected:function(){for(var a=[],b=this.itemContainer.children,c=0;c<b.length;c++)a.push(b[c].dataset.tid);return a},showResults:function(a){var b={};a.slice(0,10).forEach(function(a){var c=this.store.getName(a.id,!0);b[c]||(b[c]=[]);b[c].push(a.id)},this);var c=[],d;for(d in b)1<b[d].length&&(c=c.concat(b[d]));0<c.length?this.addPathInfo(a,
c).then(this.createMenuItems.bind(this)):this.createMenuItems(a)},whenAll:function(a){var b=a.length,c=[],d=when.defer();a.forEach(function(a,f){var g;g=function(a){b--;c[f]=a;0===b&&d.resolve(c)};a.then(function(a){g(a)})});return d},addPathInfo:function(a,b){var c=this.store;return this.whenAll(b.map(function(a){return c.getAncestors(a)})).then(function(d){var e={};d.forEach(function(a,d){e[b[d]]=a.map(function(a){return c.getName(a,!0)}).join(" > ")});return a.map(function(a){e[a.id]&&(a.path=
e[a.id]);return a})})},createMenuItems:function(a){var b=this.menu;b.innerHTML="";a.forEach(function(a){var d=document.createElement("div");d.className="tagListMenuItem";d.dataset.tid=a.id;d.textContent=this.store.getName(a.id,!0);a.path&&(d.title=a.path);b.appendChild(d)},this);this.openMenu()},openMenu:function(){var a=this.menu,b=this.editor;a.style.display="block";var c=document.body,b=b.getBoundingClientRect();a.style.left=a.offsetWidth+b.left>c.offsetWidth?c.offsetWidth-a.offsetWidth+"px":b.left+
"px";a.style.top=b.top+b.height+3+"px";this.isMenuOpen=!0},closeMenu:function(){if(this.isMenuOpen){var a=this.menu;a.innerHTML="";a.style.display="none";this.isMenuOpen=!1;this.selectedIndex=-1;this.editor.classList.add("tagListMenuItemSelected");this.cache=[]}},addEventListeners:function(){var a=this;this.on("click",".tagListItemLabel",function(b){a.emit("taglist-click",{id:b.target.parentNode.parentNode.dataset.tid})});this.on("click",".tagListItemRemoveButton",function(b){b=b.target.parentNode.parentNode.dataset.tid;
a.removeItem(b);a.emit("taglist-remove",{id:b})});$(document.body).on("click",function(b){["tagListAddButton","tagListAddButtonContent","tagListAddButtonLabel","tagListEditor","tagListMenuItem"].every(function(a){return!b.target.classList.contains(a)})&&a.closeEditor()})},handleEditorKeydown:function(a){var b=this.keys;switch(a.keyCode){case b.UP:this.moveSelection(!0);break;case b.DOWN:this.moveSelection(!1);break;case b.ENTER:this.selectItem()}},moveSelection:function(a){if(this.isMenuOpen){var b=
this.menu.children,c=this.selectedIndex,a=a&&-1===c?b.length-1:!a&&c===b.length-1?-1:c+(a?-1:1);-1<c?b[c].classList.remove("tagListMenuItemSelected"):this.editor.classList.remove("tagListMenuItemSelected");-1<a?b[a].classList.add("tagListMenuItemSelected"):this.editor.classList.add("tagListMenuItemSelected");this.selectedIndex=a}}};
