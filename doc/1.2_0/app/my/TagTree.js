function TagTree(a,b){this.id=b;this._loaded=[];for(var d in a)this[d]=a[d];$("#"+b).jstree({plugins:["themes","json_data","checkbox","crrm","contextmenu"],core:{animation:300,initially_open:this.options.expandTopLevel?[this.getNodeId(this.store.topLevelContainerId)]:[]},themes:{theme:"classic"},json_data:{data:this.getData.bind(this)},checkbox:{two_state:!0},contextmenu:{items:this.getMenu.bind(this)}});document.getElementById(b).classList.add("tagTree");this.jsTree=$.jstree._reference(b);this.createCustomEvents();
this.handleEditEvents()}
TagTree.prototype={options:null,store:null,externalSelector:null,multiple:!0,prefix:"tag_",getNodeId:function(a){return"#"+this.prefix+a},getMenu:function(a){var b=a.data("id"),d=chrome.i18n.getMessage,b=b===this.store.bookmarksBarId||b===this.store.topLevelContainerId;return{rename:{label:d("popup_renameIconTooltip"),action:function(){this.rename(a)},separator_after:!1,_disabled:b},create:{label:d("popup_addIconTooltip"),action:function(){this.create(a,"last",{attr:{id:"tag_NEW"},data:d("newTag")})},
separator_after:!1}}},getChecked:function(){for(var a=this.jsTree.get_checked(),b=[],d=0;d<a.length;d++)b.push($(a[d]).data("id"));return b},getData:function(a,b){var d=this,e=this.store,c=-1===a?e.rootId:a.data("id");this._loaded.push(c);e.getChildren(c).then(function(a){for(var c=[],i=0;i<a.length;i++){var g=a[i],f={};f.data=g.title;f.attr={id:d.prefix+g.id};d.externalSelector&&0<=d.externalSelector.getSelected().indexOf(g.id)&&(f.attr["class"]="jstree-checked");f.metadata={id:g.id};e.mayHaveChildren(g)&&
(f.state="closed");c.push(f)}b(0<c.length?c:!1)})},expandDownTo:function(a){var b=this;this.store.getAncestors(a).then(function(a){b.expandRecursive(a)})},expandRecursive:function(a){for(;0<a.length;){var b=this.getNodeId(a.shift());if(0===a.length)document.querySelector(b).scrollIntoView(!1);else if(!this.jsTree.is_open(b)){this.jsTree.open_node(b,this.expandRecursive.bind(this,a));break}}},check:function(a){this.jsTree.check_node(this.getNodeId(a))},uncheck:function(a){this.jsTree.uncheck_node(this.getNodeId(a))},
uncheckAll:function(){this.jsTree.uncheck_all()},create:function(a){0<=this._loaded.indexOf(a.parentId)&&this.jsTree.create(this.getNodeId(a.parentId),"last",{attr:{id:this.prefix+a.id},data:a.title,metadata:{id:a.id}},null,!0)},handleEditEvents:function(){var a=this,b=$("#"+this.id);$(b).on("rename.jstree",function(d,e){var c=e.rslt.obj.data("id");a.store.put({id:c,title:e.rslt.new_name},{changed:"title"}).then(function(){$(b).trigger("tagtree-rename",{id:c})})});$(b).on("create.jstree",function(b,
e){var c=e.rslt.obj,j=e.rslt.parent,h=c.attr("id").match(/tag_(.+)$/)[1];a.store.has(h)?(c.data("id",h),a.check(h)):a.store.add({title:e.rslt.name,parentId:j.data("id")}).then(function(b){c.attr("id",a.prefix+b);c.data("id",b)})});$(b).on("create_node.jstree",function(a,b){b.rslt.obj.get()[0].scrollIntoView(!1)})},createCustomEvents:function(){var a=this,b=$("#"+this.id);$(b).on("check_node.jstree",function(d,e){var c=e.rslt.obj.data("id");$(b).trigger("tagtree-check",{id:c});a.multiple||a.getChecked().forEach(function(b){b!==
c&&a.uncheck(b)})});$(b).on("uncheck_node.jstree",function(a,e){var c=e.rslt.obj.data("id");$(b).trigger("tagtree-uncheck",{id:c})})},on:function(a,b){var d=$("#"+this.id);$(d).on(a,b)},refresh:function(){this.jsTree.refresh()}};
