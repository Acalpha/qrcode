var popup={currentItem:null,i18n:chrome.i18n.getMessage,init:function(){this.bg=chrome.extension.getBackgroundPage().bg;this.store=this.bg.tagStore;this.createUi()},createUi:function(){var b=this;this.setCurrentItem().then(function(a){["TitleBar","InputFields","TagTree","SaveButton"].forEach(function(c){b["create"+c](a)})})},createTitleBar:function(b){document.getElementById("titleBarLabel").textContent=this.i18n("popup_titleBarLabel");if(b){b=document.getElementById("deleteButton");b.textContent=
this.i18n("popup_deleteButtonLabel");b.style.display="block";var a=this;$(b).on("click",function(){a.bg.removeBookmark(a.currentItem);window.close()})}},createInputFields:function(b){["title","tags"].forEach(function(a){document.getElementById(a+"FieldLabel").textContent=this.i18n("popup_"+a+"FieldLabel");this[a+"Field"]="title"===a?document.getElementById(a+"Field"):new TagList({store:this.store,defaultParentId:this.bg.options.defaultParentId},a+"Field")},this);var a=this,c=this.titleField,d=this.tagsField;
b?(c.value=b.title,0<b.tids.length&&b.tids.forEach(function(a){d.addItem(a)})):(c.value=this.currentTab.title,c.select());$(c).on("input",this.validate.bind(this));d.on("taglist-click",function(b,c){a.tagTree.expandDownTo(c.id)});d.on("taglist-remove",function(b,c){a.tagTree.uncheck(c.id);a.validate()});d.on("taglist-add",function(b,c){a.tagTree.check(c.id);a.validate()});d.on("taglist-create",function(b,c){a.tagTree.create(c);a.validate()})},createTagTree:function(){var b=this,a=this.tagsField,c=
this.tagTree=new TagTree({store:this.store,options:this.bg.options,externalSelector:a},"tagTree");c.on("tagtree-check",function(c,e){0>a.getSelected().indexOf(e.id)&&(a.addItem(e.id),b.validate())});c.on("tagtree-uncheck",function(c,e){0<=a.getSelected().indexOf(e.id)&&(a.removeItem(e.id),b.validate())});c.on("tagtree-rename",function(b,c){a.renameItem(c.id)})},createSaveButton:function(){var b=this.saveButton=document.getElementById("saveButton");b.textContent=this.i18n("popup_saveButtonLabel");
b.disabled=!0;var a=this;$(b).on("click",function(){var b={id:a.currentTab.url,title:a.titleField.value.trim(),tids:a.tagsField.getSelected()};a.currentItem?a.bg.updateBookmark(a.currentItem,b):a.bg.addBookmark(b);window.close()})},setCurrentItem:function(){var b=this,a=when.defer();this.getSelectedTab().then(function(c){b.currentTab=c;b.bg.bookmarkStore.get(c.url).then(function(c){b.currentItem=c;a.resolve(c)})});return a},getSelectedTab:function(){var b=when.defer();chrome.windows.getLastFocused(function(a){chrome.tabs.query({windowId:a.id,
active:!0},function(a){b.resolve(a[0])})});return b},validate:function(){var b=!1,a=this.titleField.value.trim(),c=this.tagsField.getSelected(),d=this.currentItem;if(a&&0<c.length)if(d){if(a!==d.title||c.length!==d.tids.length||c.some(function(a){return 0>d.tids.indexOf(a)}))b=!0}else b=!0;if(this.bg.options.alertBar)this.saveButton.parentNode.classList[b?"add":"remove"]("unsaved");this.saveButton.disabled=!b;return b}};$(function(){popup.init()});
